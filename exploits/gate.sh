#!/bin/bash
K=$(uname -r)
E=()

# Check pkexec SUID
[ -u /usr/bin/pkexec ] 2>/dev/null && E+=('{"cve":"CVE-2021-4034","name":"PwnKit - pkexec SUID","rate":95}')

# Check DirtyPipe kernel range
if [[ "$K" > "5.8" && "$K" < "5.17" ]]; then
    E+=('{"cve":"CVE-2022-0847","name":"DirtyPipe - kernel overwrite","rate":90}')
fi

# Check DirtyCOW
[[ "$K" < "4.9" ]] && E+=('{"cve":"CVE-2016-5195","name":"DirtyCOW - race condition","rate":80}')

# Check sudo NOPASSWD without prompting (timeout immediately)
if timeout 1 sudo -n -l 2>/dev/null | grep -q NOPASSWD 2>/dev/null; then
    E+=('{"cve":"SUDO-NOPASSWD","name":"Sudo without password","rate":99}')
fi

# Check writable passwd/shadow
[ -w /etc/passwd ] 2>/dev/null && E+=('{"cve":"PASSWD-WRITE","name":"Writable /etc/passwd","rate":99}')
[ -w /etc/shadow ] 2>/dev/null && E+=('{"cve":"SHADOW-WRITE","name":"Writable /etc/shadow","rate":99}')

# Check SUID binaries
for bin in /usr/bin/vim /usr/bin/find /usr/bin/nmap /usr/bin/python* /usr/bin/perl /usr/bin/ruby; do
    [ -u "$bin" ] 2>/dev/null && E+=("{\"cve\":\"SUID-$(basename $bin)\",\"name\":\"SUID $(basename $bin)\",\"rate\":85}")
done

# Output JSON
printf '{"exploits":['
for i in "${!E[@]}"; do
    [[ $i -gt 0 ]] && printf ','
    printf '%s' "${E[$i]}"
done
printf ']}'
